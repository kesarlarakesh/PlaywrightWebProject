name: Playwright CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Run daily at 5 PM UTC
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Test environment to run'
        required: true
        default: 'lambdatest'
        type: choice
        options:
          - local
          - lambdatest
          - both

# Set minimal permissions for GITHUB_TOKEN
permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm install
      - name: Install ESLint
        run: npm install eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin --save-dev
      - name: Setup ESLint if needed
        run: |
          if [ ! -f .eslintrc.js ]; then
            echo 'module.exports = { parser: "@typescript-eslint/parser", plugins: ["@typescript-eslint"], extends: ["eslint:recommended", "plugin:@typescript-eslint/recommended"], rules: {}, env: { node: true } };' > .eslintrc.js
          fi
      - name: Run linting
        run: npx eslint . --ext .ts

  vulnerability-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install dependencies
        run: npm install
      - name: Run vulnerability scan
        run: npm audit

  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    needs: [lint, vulnerability-scan]
    outputs:
      custom_report_url: ${{ steps.upload-reports.outputs.custom_report_url }}
      bucket_url: ${{ steps.upload-reports.outputs.bucket_url }}
    env:
      USE_LAMBDATEST: ${{ (github.event.inputs.test_environment == 'lambdatest' || github.event.inputs.test_environment == 'both' || github.event.inputs.test_environment == null) && 'true' || 'false' }}
      LT_USERNAME: ${{ secrets.LT_USERNAME }}
      LT_ACCESS_KEY: ${{ secrets.LT_ACCESS_KEY }}
      TEST_MODE: ${{ github.event.inputs.test_environment || 'lambdatest' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      # Only install browsers for local testing
      - name: Install Playwright Browsers
        if: github.event.inputs.test_environment == 'local' || github.event.inputs.test_environment == 'both'
        run: npx playwright install --with-deps chromium
      
      # Install LambdaTest Playwright for cloud testing
      - name: Install LambdaTest Playwright
        if: github.event.inputs.test_environment == 'lambdatest' || github.event.inputs.test_environment == 'both' || github.event.inputs.test_environment == null
        run: npm install @lambdatest/playwright-driver --save-dev
      
      # Run tests
      - name: Run Playwright tests (Local)
        if: github.event.inputs.test_environment == 'local' || github.event.inputs.test_environment == 'both'
        env:
          USE_LAMBDATEST: false
        run: npm run test
      
      - name: Run Playwright tests (LambdaTest)
        if: github.event.inputs.test_environment == 'lambdatest' || github.event.inputs.test_environment == 'both' || github.event.inputs.test_environment == null
        env:
          USE_LAMBDATEST: true
        run: npm run test
      
      # Google Cloud SDK Setup and Report Upload
      - name: Setup Google Cloud SDK
        if: always()
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Authenticate to Google Cloud
        if: always()
        run: |
          echo "🔐 Setting up Google Cloud Authentication..."
          
          # Check if secret exists
          if [ -z "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" ]; then
            echo "❌ GCP_SERVICE_ACCOUNT_KEY secret is not set"
            echo "   Please add your service account JSON to GitHub secrets"
            exit 1
          fi
          
          # Create service account key file
          echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/gcp-key.json
          
          # Validate JSON format
          if ! jq empty /tmp/gcp-key.json 2>/dev/null; then
            echo "❌ Invalid JSON format in GCP_SERVICE_ACCOUNT_KEY"
            echo "   Please ensure the secret contains valid JSON"
            exit 1
          fi
          
          # Extract service account info for debugging
          PROJECT_ID=$(jq -r '.project_id' /tmp/gcp-key.json)
          CLIENT_EMAIL=$(jq -r '.client_email' /tmp/gcp-key.json)
          
          echo "✅ Service Account: $CLIENT_EMAIL"
          echo "✅ Project ID: $PROJECT_ID"
          
          # Activate service account
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
          
          # Set project
          gcloud config set project $PROJECT_ID
          
          # Verify authentication
          echo "� Verifying authentication..."
          gcloud auth list --format="table(account,status)"
      
      - name: Debug GCS Authentication
        if: always()
        run: |
          echo "🔍 Testing Google Cloud Authentication..."
          
          # Test authentication
          echo "🔐 Current authenticated accounts:"
          gcloud auth list --format="table(account,status)"
          
          # Check project configuration
          echo "📋 Current project:"
          gcloud config get-value project
          
          # Test gsutil authentication
          echo "🛠️ Testing gsutil configuration..."
          gsutil version
          
          # Test bucket access
          echo "🪣 Testing bucket access..."
          if gsutil ls gs://testautomationweb; then
            echo "✅ Bucket access successful!"
          else
            echo "❌ Bucket access failed"
            echo "   This indicates either:"
            echo "   1. Bucket doesn't exist"
            echo "   2. Service account lacks storage.objects.list permission"
            echo "   3. Service account lacks storage.buckets.get permission"
          fi
      
      - name: Upload Playwright Reports to Google Cloud Storage
        if: always()
        id: upload-reports
        run: |
          echo "📤 Starting Playwright Reports upload to Google Cloud Storage..."
          
          # Get environment type for folder organization
          ENV_TYPE="${{ github.event.inputs.test_environment || 'lambdatest' }}"
          
          # Create folder name in GCS bucket
          GCS_FOLDER="playwright-reports/${ENV_TYPE}"
          BUCKET_NAME="testautomationweb"
          
          echo "� Target location: gs://${BUCKET_NAME}/${GCS_FOLDER}/"
          
          # Verify we have an active authentication
          ACTIVE_ACCOUNT=$(gcloud auth list --filter="status:ACTIVE" --format="value(account)")
          if [ -z "$ACTIVE_ACCOUNT" ]; then
            echo "❌ No active Google Cloud authentication found"
            echo "   Authentication step may have failed"
            exit 1
          else
            echo "✅ Using authenticated account: $ACTIVE_ACCOUNT"
          fi
          
          # Verify bucket exists and is accessible
          echo "🪣 Verifying bucket access..."
          if ! gsutil ls gs://${BUCKET_NAME}/ > /dev/null 2>&1; then
            echo "❌ Cannot access bucket gs://${BUCKET_NAME}/"
            echo "   Please verify:"
            echo "   1. Bucket exists"
            echo "   2. Service account has storage.objects.list permission"
            echo "   3. Service account has storage.buckets.get permission"
            exit 1
          else
            echo "✅ Bucket access verified"
          fi
          
          # Upload report folders with error handling
          UPLOAD_SUCCESS=false
          if ls playwright-web-report-* 1> /dev/null 2>&1; then
            for report_dir in playwright-web-report-*; do
              if [ -d "$report_dir" ]; then
                echo "📤 Uploading $report_dir..."
                if gsutil -m cp -r "$report_dir" gs://${BUCKET_NAME}/${GCS_FOLDER}/; then
                  echo "✅ Successfully uploaded $report_dir"
                  UPLOAD_SUCCESS=true
                else
                  echo "❌ Failed to upload $report_dir"
                  echo "   Error details above. Common causes:"
                  echo "   - Missing storage.objects.create permission"
                  echo "   - Invalid service account configuration"
                  echo "   - Network connectivity issues"
                fi
              fi
            done
          else
            echo "⚠️  No playwright-web-report-* folders found to upload"
          fi
          
          # Proceed with public access only if upload was successful
          if [ "$UPLOAD_SUCCESS" = true ]; then
            echo "🔒 Setting public access for the uploaded reports..."
            if gsutil -m acl ch -r -u AllUsers:R gs://${BUCKET_NAME}/${GCS_FOLDER}/; then
              echo "✅ Public access configured successfully"
            else
              echo "⚠️  Failed to set public access (reports uploaded but not public)"
            fi
            
            # Check for custom named HTML report
            CUSTOM_REPORT_URL=""
            if ls playwright-web-report-*/PlaywrightAutomationTestResult.html 1> /dev/null 2>&1; then
              CUSTOM_REPORT_DIR=$(ls -d playwright-web-report-* | head -n 1)
              CUSTOM_REPORT_URL="https://storage.googleapis.com/${BUCKET_NAME}/${GCS_FOLDER}/${CUSTOM_REPORT_DIR}/PlaywrightAutomationTestResult.html"
              echo "📋 Custom report URL: $CUSTOM_REPORT_URL"
            fi
            
            # Set outputs for use in notification
            echo "gcs_folder=${GCS_FOLDER}" >> $GITHUB_OUTPUT
            echo "custom_report_url=${CUSTOM_REPORT_URL}" >> $GITHUB_OUTPUT
            echo "bucket_url=https://console.cloud.google.com/storage/browser/${BUCKET_NAME}/${GCS_FOLDER}" >> $GITHUB_OUTPUT
            
            echo "🎉 Reports uploaded successfully!"
            if [ -n "$CUSTOM_REPORT_URL" ]; then
              echo "📊 Custom Report URL: $CUSTOM_REPORT_URL"
            fi
          else
            echo "❌ Upload failed. Skipping public access configuration."
            echo "   Please check the authentication and permissions."
            # Set empty outputs so the workflow doesn't break
            echo "gcs_folder=" >> $GITHUB_OUTPUT
            echo "custom_report_url=" >> $GITHUB_OUTPUT
            echo "bucket_url=" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.event.inputs.test_environment || 'lambdatest' }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  notify:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-${{ github.event.inputs.test_environment || 'lambdatest' }}
          path: ./
      - name: Extract Test Statistics
        id: extract-stats
        run: |
          # Check for test results file
          echo "Looking for test results..."
          
          # First check standard location
          if [ -f "test-results/json-report.json" ]; then
            JSON_PATH="test-results/json-report.json"
            echo "Found report at: $JSON_PATH"
          else
            # Look for any JSON files in test-results directory
            JSON_FILES=$(find . -path "*/test-results/*.json" 2>/dev/null)
            
            if [ -n "$JSON_FILES" ]; then
              JSON_PATH=$(echo "$JSON_FILES" | head -n 1)
              echo "Using alternative report: $JSON_PATH"
            else
              echo "No test report files found"
              JSON_PATH=""
            fi
          fi
          
          # Process test results if file exists
          if [ -n "$JSON_PATH" ] && [ -f "$JSON_PATH" ]; then
            # Install jq if not available (ensures it's present)
            if ! command -v jq &> /dev/null; then
              echo "Installing jq for JSON parsing"
              apt-get update && apt-get install -y jq
            fi
            
            echo "Extracting test statistics with jq"
            # Use Playwright's precise JSON structure to count only actual tests
            # First, check the structure to determine the proper jq query
            if jq '.suites[0].suites[0].specs' "$JSON_PATH" | grep -q -v "null"; then
              echo "Using standard Playwright test structure"
              # Count specs directly - this represents the actual test cases
              TOTAL_SPECS=$(jq '.suites[0].suites[0].specs | length' "$JSON_PATH" || echo 0)
              echo "Found $TOTAL_SPECS test specifications"
              
              # Count test results by status
              PASSED=$(jq '[.suites[0].suites[0].specs[].tests[].results[] | select(.status == "passed" or .status == "expected")] | length' "$JSON_PATH" || echo 0)
              FAILED=$(jq '[.suites[0].suites[0].specs[].tests[].results[] | select(.status == "failed" or .status == "unexpected")] | length' "$JSON_PATH" || echo 0)
              FLAKY=$(jq '[.suites[0].suites[0].specs[].tests[].results[] | select(.status == "flaky")] | length' "$JSON_PATH" || echo 0)
              SKIPPED=$(jq '[.suites[0].suites[0].specs[].tests[].results[] | select(.status == "skipped")] | length' "$JSON_PATH" || echo 0)
              
              # Use spec count as total tests, which matches your test case count
              TOTAL=$TOTAL_SPECS
            else
              echo "Falling back to simpler test counting"
              PASSED=$(jq '[.. | objects | select(.status == "passed" or .status == "expected")] | length' "$JSON_PATH" || echo 0)
              FAILED=$(jq '[.. | objects | select(.status == "failed" or .status == "unexpected")] | length' "$JSON_PATH" || echo 0)
              FLAKY=$(jq '[.. | objects | select(.status == "flaky")] | length' "$JSON_PATH" || echo 0)
              SKIPPED=$(jq '[.. | objects | select(.status == "skipped")] | length' "$JSON_PATH" || echo 0)
              TOTAL=$((PASSED + FAILED + FLAKY + SKIPPED))
            fi
          else
            echo "No valid test report found. Using default values."
            TOTAL="0"
            PASSED="0"
            FAILED="0"
            FLAKY="0"
            SKIPPED="0"
          fi
          
          # Display what was found for debugging in the workflow
          echo "Found test statistics: Total: $TOTAL, Passed: $PASSED, Failed: $FAILED, Flaky: $FLAKY, Skipped: $SKIPPED"
          
          # Set outputs for use in next step
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "flaky=$FLAKY" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          
          # Create a summary for direct use in the notification
          echo "summary=Total: $TOTAL | Passed: $PASSED | Failed: $FAILED | Flaky: $FLAKY | Skipped: $SKIPPED" >> $GITHUB_OUTPUT
      - name: Notify Slack
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: "Playwright Test Results"
          SLACK_MESSAGE: |
            *Test Statistics*
            Total: ${{ steps.extract-stats.outputs.total }}
            Passed: ${{ steps.extract-stats.outputs.passed }} ✅
            Failed: ${{ steps.extract-stats.outputs.failed }} ❌
            Flaky: ${{ steps.extract-stats.outputs.flaky }} ⚠️
            Skipped: ${{ steps.extract-stats.outputs.skipped }} ⏭️
            
            *Build Information*
            Build: ${{ github.run_id }}
            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
            Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            *Test Reports (Google Cloud Storage)*
            📊 Custom Report: ${{ needs.test.outputs.custom_report_url }}
            🗂️ GCS Console: ${{ needs.test.outputs.bucket_url }}
